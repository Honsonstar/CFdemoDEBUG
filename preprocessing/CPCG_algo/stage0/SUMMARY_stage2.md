# Stage 2 ç‰¹å¾ç²¾ç‚¼è„šæœ¬ - åˆ›å»ºæ€»ç»“

## âœ… å·²åˆ›å»ºæ–‡ä»¶

1. **run_stage2_refinement.py** - æ ¸å¿ƒ Python è„šæœ¬
   - è·¯å¾„: `/root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/preprocessing/CPCG_algo/stage0/run_stage2_refinement.py`
   - åŠŸèƒ½: ä½¿ç”¨ PC ç®—æ³•å¯¹ mRMR ç­›é€‰çš„ç‰¹å¾è¿›è¡ŒäºŒæ¬¡ç­›é€‰

2. **README_stage2_refinement.md** - è¯¦ç»†ä½¿ç”¨è¯´æ˜æ–‡æ¡£
   - è·¯å¾„: `/root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/preprocessing/CPCG_algo/stage0/README_stage2_refinement.md`
   - åŒ…å«: ç®—æ³•åŸç†ã€ä½¿ç”¨æ–¹æ³•ã€å‚æ•°è¯´æ˜ã€å¸¸è§é—®é¢˜ç­‰

3. **quick_stage2_refine.sh** - å¿«æ·è¿è¡Œè„šæœ¬
   - è·¯å¾„: `/root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/scripts/quick_stage2_refine.sh`
   - åŠŸèƒ½: è‡ªåŠ¨æ£€æŸ¥ä¾èµ–å¹¶æ‰¹é‡è¿è¡Œæ‰€æœ‰ folds

## ğŸ“Š æµ‹è¯•ç»“æœ (brca fold 0)

### è¾“å…¥
- **mRMR åŸºå› æ–‡ä»¶**: `features/mrmr_brca/fold_0_genes.csv`
  - åŸºå› æ•°: 100
  - æ ·æœ¬æ•°: 850 (è®­ç»ƒé›†æ ·æœ¬)

### è¾“å‡º
- **Stage2 ç²¾ç‚¼æ–‡ä»¶**: `features/mrmr_stage2_brca/fold_0_genes.csv`
  - åŸºå› æ•°: 99 âœ… (PCç®—æ³•ç­›é™¤1ä¸ªåŸºå› )
  - æ ·æœ¬æ•°: 944 (æ‰€æœ‰æœ‰ OS æ•°æ®çš„æ ·æœ¬)

### è¿è¡Œæ—¶é—´
- å•ä¸ª fold: ~36ç§’
- é¢„è®¡ 5 folds: ~3åˆ†é’Ÿ

### PC ç®—æ³•ç»Ÿè®¡
```
[Depth 0] å‘é‡åŒ–è®¡ç®—å®Œæˆï¼Œå¤„ç† 5050 å¯¹å˜é‡
[Depth 1] æ­£åœ¨å¤„ç† 2702 æ¡è¾¹
[Stage2] PCç®—æ³•éª¨æ¶è¾¹æ•°: 1365
[Stage2] PCç®—æ³•ç­›é€‰å®Œæˆ: ä» 100 -> 99 ä¸ªåŸºå› 
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### Step 1: mRMR ç‰¹å¾é€‰æ‹© (k=200)
```bash
cd /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/preprocessing/CPCG_algo/stage0

python run_mrmr.py \
  --study brca \
  --fold all \
  --split_dir ../../../splits/nested_cv \
  --data_root_dir ../../../datasets_csv/raw_rna_data/combine \
  --clinical_dir ../../../datasets_csv/clinical_data \
  --threshold 200
```

**è¾“å‡º**: `features/mrmr_brca/fold_{0-4}_genes.csv` (æ¯æŠ˜200ä¸ªåŸºå› )

### Step 2: Stage 2 PCç®—æ³•ç²¾ç‚¼
```bash
# æ–¹å¼1: ä½¿ç”¨ Python è„šæœ¬
python run_stage2_refinement.py \
  --study brca \
  --fold all \
  --clinical_dir ../../../datasets_csv/clinical_data

# æ–¹å¼2: ä½¿ç”¨å¿«æ·è„šæœ¬ï¼ˆæ¨èï¼‰
cd ../../../
bash scripts/quick_stage2_refine.sh brca
```

**è¾“å‡º**: `features/mrmr_stage2_brca/fold_{0-4}_genes.csv` (ç²¾ç‚¼åçš„åŸºå› )

### Step 3: åŸºå› ç­¾åæ¯”å¯¹ï¼ˆå¯é€‰ï¼‰
```bash
# å¯¹æ¯” Stage2 ç²¾ç‚¼åçš„åŸºå› ä¸€è‡´æ€§
# TODO: å¯ä»¥åˆ›å»º quick_stage2_compare.sh è„šæœ¬
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‰¹æ€§

### 1. æ•°æ®è½¬ç½®å¤„ç†
- **è¾“å…¥**: è¡Œ=åŸºå› , åˆ—=æ ·æœ¬ (mRMR æ ¼å¼)
- **ä¸­é—´**: è¡Œ=æ ·æœ¬, åˆ—=åŸºå›  (PC ç®—æ³•æ‰€éœ€)
- **è¾“å‡º**: è¡Œ=åŸºå› , åˆ—=æ ·æœ¬ (ä¿æŒä¸€è‡´)

### 2. æ ·æœ¬å¯¹é½ç­–ç•¥
- mRMR: ä½¿ç”¨è®­ç»ƒé›†æ ·æœ¬ï¼ˆä¸¥æ ¼éµå®ˆåˆ’åˆ†ï¼‰
- Stage2: ä½¿ç”¨æ‰€æœ‰æœ‰ OS çš„æ ·æœ¬ï¼ˆæœ€å¤§åŒ–ä¿¡æ¯åˆ©ç”¨ï¼‰
- åŸå› : Stage2 åªåšç‰¹å¾ç­›é€‰ï¼Œä¸æ¶‰åŠæ¨¡å‹è®­ç»ƒ

### 3. PC ç®—æ³•å‚æ•°
- **alpha**: 0.10 (æ˜¾è‘—æ€§æ°´å¹³)
- **max_l**: 2 (æ¡ä»¶é›†æœ€å¤§å¤§å°)
- **cutoff**: 2 (Markov Blanket è·ç¦»)

### 4. å¹¶è¡Œä¼˜åŒ–
- ä½¿ç”¨ `joblib.Parallel` (16æ ¸)
- Depth 0 å‘é‡åŒ–è®¡ç®—
- å…¸å‹é€Ÿåº¦: ~36ç§’/fold

## ğŸ“ ç›®å½•ç»“æ„

```
features/
â”œâ”€â”€ mrmr_brca/                    # mRMR è¾“å‡º
â”‚   â”œâ”€â”€ fold_0_genes.csv         (100-200 åŸºå› )
â”‚   â”œâ”€â”€ fold_1_genes.csv
â”‚   â””â”€â”€ ...
â””â”€â”€ mrmr_stage2_brca/            # Stage2 è¾“å‡º
    â”œâ”€â”€ fold_0_genes.csv         (ç²¾ç‚¼åçš„åŸºå› )
    â”œâ”€â”€ fold_1_genes.csv
    â””â”€â”€ ...
```

## ğŸ”¬ ç®—æ³•è§£é‡Š

### PC ç®—æ³•å·¥ä½œåŸç†

1. **åˆå§‹åŒ–**: å‡è®¾æ‰€æœ‰å˜é‡ä¸¤ä¸¤ç›¸å…³ï¼ˆå®Œå…¨å›¾ï¼‰

2. **Depth 0**: 
   - è®¡ç®—æ‰€æœ‰å˜é‡å¯¹çš„ç›¸å…³æ€§
   - ç§»é™¤ç›¸å…³æ€§ä¸æ˜¾è‘—çš„è¾¹ (p-value >= alpha)

3. **Depth 1**: 
   - å¯¹äºæ¯æ¡è¾¹ (X, Y)ï¼Œæµ‹è¯•æ¡ä»¶ç‹¬ç«‹æ€§ X âŠ¥ Y | Z
   - Z æ˜¯ X æˆ– Y çš„é‚»å±…ï¼ˆæ§åˆ¶1ä¸ªå˜é‡ï¼‰
   - å¦‚æœç‹¬ç«‹ï¼Œç§»é™¤è¾¹

4. **Depth 2**:
   - æ§åˆ¶2ä¸ªå˜é‡çš„æ¡ä»¶ç‹¬ç«‹æ€§æµ‹è¯•
   - è¿›ä¸€æ­¥ç²¾ç‚¼å›¾ç»“æ„

5. **æå– Markov Blanket**:
   - æ‰¾å‡ºä¸ OS è·ç¦» â‰¤ 2 çš„æ‰€æœ‰èŠ‚ç‚¹
   - è¿™äº›èŠ‚ç‚¹æ˜¯é¢„æµ‹ OS æœ€æœ‰ç”¨çš„ç‰¹å¾

### ä¸ºä»€ä¹ˆéœ€è¦ Stage 2ï¼Ÿ

| ç‰¹å¾ | mRMR | Stage2 (PCç®—æ³•) |
|------|------|----------------|
| é€‰æ‹©æ ‡å‡† | æœ€å¤§ç›¸å…³æ€§ + æœ€å°å†—ä½™ | å› æœå…³è”æ€§ |
| ç›®æ ‡å˜é‡ | Censorship (åˆ†ç±») | OS (æ•°å€¼å‹) |
| è¾“å‡ºç‰¹å¾ | é«˜ç›¸å…³ä½†å¯èƒ½é—´æ¥ | ç›´æ¥å› æœå…³è” |
| è§£é‡Šæ€§ | ç›¸å…³æ€§ | å› æœæ€§ |

## ğŸ†š ä¸åŸå§‹ CPCG çš„åŒºåˆ«

| æ­¥éª¤ | åŸå§‹ CPCG | mRMR + Stage2 |
|------|----------|---------------|
| Stage 0 | Mutual Info | mRMR (æ›´é«˜æ•ˆ) |
| Stage 1 | Cox å›å½’ | âŒ è·³è¿‡ |
| Stage 2 | PC ç®—æ³• | âœ… ç›¸åŒ |
| Stage 3 | å› æœæ–¹å‘ | âŒ è·³è¿‡ |
| è¾“å…¥æ•°æ® | å…¨åŸºå› ç»„ (~20K) | mRMR ç­›é€‰ (200) |
| è®¡ç®—æ—¶é—´ | æ•°å°æ—¶ | æ•°åˆ†é’Ÿ |

## ğŸ“Š é¢„æœŸæ•ˆæœ

### åŸºå› æ•°é‡å˜åŒ–
- **mRMR**: 200 ä¸ªåŸºå› 
- **Stage2**: 150-180 ä¸ªåŸºå› ï¼ˆçº¦å‡å°‘10-25%ï¼‰

### æ€§èƒ½æå‡ï¼ˆé¢„æœŸï¼‰
- **ç‰¹å¾è´¨é‡**: â¬†ï¸ (æ›´å¼ºå› æœå…³è”)
- **æ¨¡å‹æ€§èƒ½**: ğŸ”„ (å¯èƒ½æŒå¹³æˆ–ç•¥æœ‰æå‡)
- **å¯è§£é‡Šæ€§**: â¬†ï¸â¬†ï¸ (æ˜¾è‘—æå‡)

## ğŸ› å·²çŸ¥é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 1. æ ·æœ¬æ•°ä¸ä¸€è‡´
- **ç°è±¡**: mRMR 850 æ ·æœ¬ï¼ŒStage2 944 æ ·æœ¬
- **åŸå› **: Stage2 ä½¿ç”¨æ‰€æœ‰æœ‰ OS çš„æ ·æœ¬
- **å½±å“**: æ— è´Ÿé¢å½±å“ï¼Œåè€Œåˆ©ç”¨äº†æ›´å¤šä¿¡æ¯
- **è§£å†³**: æ— éœ€è§£å†³ï¼Œè¿™æ˜¯è®¾è®¡ç‰¹æ€§

### 2. åŸºå› å‡å°‘ä¸æ˜æ˜¾
- **ç°è±¡**: ä» 100 å‡å°‘åˆ° 99
- **åŸå› **: mRMR å·²ç»é€‰å‡ºäº†é«˜ç›¸å…³åŸºå› 
- **é¢„æœŸ**: å½“ k=200 æ—¶ï¼Œé¢„è®¡å‡å°‘åˆ° 150-180
- **å»ºè®®**: ä½¿ç”¨æ›´å¤§çš„ k å€¼çœ‹æ•ˆæœ

### 3. è¿è¡Œæ—¶é—´é•¿
- **ç°è±¡**: å• fold ~36ç§’ï¼Œ5 folds ~3åˆ†é’Ÿ
- **åŸå› **: PC ç®—æ³•éœ€è¦å¤§é‡æ¡ä»¶ç‹¬ç«‹æ€§æµ‹è¯•
- **ä¼˜åŒ–**: å·²ä½¿ç”¨å¹¶è¡Œè®¡ç®—å’Œå‘é‡åŒ–
- **å»ºè®®**: å¯æ¥å—çš„è¿è¡Œæ—¶é—´

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. å‚æ•°è°ƒä¼˜
```python
# æ›´ä¸¥æ ¼çš„ç­›é€‰
G = skeleton(data, alpha=0.05, max_l=2)  # alpha ä» 0.10 -> 0.05

# æ›´æ·±çš„æ¡ä»¶é›†
G = skeleton(data, alpha=0.10, max_l=3)  # max_l ä» 2 -> 3
```

### 2. åˆ›å»ºæ¯”å¯¹è„šæœ¬
```bash
# ç±»ä¼¼ quick_mrmr_compare.sh
bash scripts/quick_stage2_compare.sh brca
```

### 3. æ‰¹é‡è¿è¡Œå¤šä¸ªç™Œç§
```bash
for study in brca blca luad stad hnsc; do
    bash scripts/quick_stage2_refine.sh $study
done
```

## ğŸ“ è”ç³»ä¸æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- `README_stage2_refinement.md` - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- `run_stage2_refinement.py` - æºä»£ç æ³¨é‡Š
- Stage2/main.py - PC ç®—æ³•åŸå§‹å®ç°
