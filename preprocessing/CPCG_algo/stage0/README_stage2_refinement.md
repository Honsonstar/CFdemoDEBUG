# Stage 2 ç‰¹å¾ç²¾ç‚¼è„šæœ¬ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`run_stage2_refinement.py` æ˜¯ä¸€ä¸ªç”¨äºå¯¹ mRMR ç­›é€‰åçš„ç‰¹å¾è¿›è¡ŒäºŒæ¬¡ç­›é€‰çš„è„šæœ¬ã€‚å®ƒä½¿ç”¨ **PC (Peter-Clark) ç®—æ³•**æ¥è¯†åˆ«ä¸ç”Ÿå­˜æ—¶é—´ (OS) **ç›´æ¥ç›¸å…³**çš„åŸºå› ï¼Œä»è€Œè·å¾—æ›´ç²¾ç‚¼çš„ç‰¹å¾å­é›†ã€‚

## ğŸ”„ æ•°æ®æµç¨‹

```
mRMR ç­›é€‰åŸºå›  (100-200ä¸ª)
    â†“
è½¬ç½®ä¸º (æ ·æœ¬ x åŸºå› ) æ ¼å¼
    â†“
ä¸ä¸´åºŠ OS æ•°æ®åˆå¹¶
    â†“
PC ç®—æ³•æ„å»ºå› æœéª¨æ¶
    â†“
æå– OS çš„ Markov Blanket (è·ç¦»â‰¤2)
    â†“
ç²¾ç‚¼åçš„åŸºå› é›†
    â†“
è½¬ç½®å› (åŸºå›  x æ ·æœ¬) æ ¼å¼
    â†“
ä¿å­˜è¾“å‡º
```

## ğŸ“‚ è¾“å…¥/è¾“å‡ºè·¯å¾„

### è¾“å…¥
- **mRMR ç‰¹å¾æ–‡ä»¶**: `features/mrmr_{study}/fold_{fold}_genes.csv`
  - æ ¼å¼: è¡Œ=åŸºå› , åˆ—=æ ·æœ¬
  - æ¥æº: `run_mrmr.py` çš„è¾“å‡º

- **ä¸´åºŠæ•°æ®**: `datasets_csv/clinical_data/tcga_{study}_clinical.csv`
  - å¿…é¡»åŒ…å« `OS` æˆ– `survival_months` åˆ—

### è¾“å‡º
- **ç²¾ç‚¼åç‰¹å¾æ–‡ä»¶**: `features/mrmr_stage2_{study}/fold_{fold}_genes.csv`
  - æ ¼å¼: è¡Œ=åŸºå› , åˆ—=æ ·æœ¬
  - ç‰¹å¾æ•°é‡: é€šå¸¸æ¯”è¾“å…¥ç•¥å°‘

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹å¼1: å¤„ç†å•ä¸ª fold

```bash
cd /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/preprocessing/CPCG_algo/stage0

python run_stage2_refinement.py \
  --study brca \
  --fold 0 \
  --clinical_dir ../../../datasets_csv/clinical_data
```

### æ–¹å¼2: æ‰¹é‡å¤„ç†æ‰€æœ‰ folds

```bash
python run_stage2_refinement.py \
  --study brca \
  --fold all \
  --clinical_dir ../../../datasets_csv/clinical_data
```

### æ–¹å¼3: ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ

```bash
cd /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy

python preprocessing/CPCG_algo/stage0/run_stage2_refinement.py \
  --study brca \
  --fold all \
  --clinical_dir datasets_csv/clinical_data
```

## ğŸ“Š å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `--study` | æ˜¯ | ç™Œç—‡ç±»å‹ | `brca`, `blca`, `luad` |
| `--fold` | æ˜¯ | Fold ç¼–å·æˆ– "all" | `0`, `1`, `all` |
| `--clinical_dir` | å¦ | ä¸´åºŠæ•°æ®ç›®å½• | `datasets_csv/clinical_data` |

## ğŸ”¬ ç®—æ³•åŸç†

### PC ç®—æ³•ç®€ä»‹

PC (Peter-Clark) ç®—æ³•æ˜¯ä¸€ç§åŸºäº**æ¡ä»¶ç‹¬ç«‹æ€§æµ‹è¯•**çš„å› æœå‘ç°ç®—æ³•ï¼š

1. **Depth 0**: è®¡ç®—æ‰€æœ‰å˜é‡å¯¹çš„ç›¸å…³æ€§ï¼Œç§»é™¤ä¸æ˜¾è‘—çš„è¾¹
2. **Depth 1**: æµ‹è¯•æ¡ä»¶ç‹¬ç«‹æ€§ï¼ˆæ§åˆ¶1ä¸ªå˜é‡ï¼‰ï¼Œè¿›ä¸€æ­¥ç²¾ç‚¼
3. **Depth 2**: æµ‹è¯•æ¡ä»¶ç‹¬ç«‹æ€§ï¼ˆæ§åˆ¶2ä¸ªå˜é‡ï¼‰ï¼Œæœ€ç»ˆç¡®å®šéª¨æ¶

### Markov Blanket

å¯¹äºç›®æ ‡å˜é‡ `OS`ï¼Œå…¶ Markov Blanket åŒ…æ‹¬ï¼š
- **ç›´æ¥é‚»å±…**: ä¸ OS ç›´æ¥ç›¸å…³çš„åŸºå› 
- **è·ç¦»2çš„é‚»å±…**: é€šè¿‡ä¸€ä¸ªä¸­ä»‹åŸºå› ä¸ OS ç›¸å…³çš„åŸºå› 

è¿™äº›åŸºå› æ˜¯å¯¹é¢„æµ‹ OS æœ€æœ‰ç”¨çš„ç‰¹å¾ã€‚

## ğŸ“ˆ è¾“å‡ºç¤ºä¾‹

```
============================================================
[Fold 0] å¤„ç†ä¸­...
============================================================

[brca] Fold 0: å¼€å§‹ Stage 2 ç‰¹å¾ç²¾ç‚¼...
  [æ•°æ®] mRMR åŸºå› æ–‡ä»¶: 100 åŸºå›  x 850 æ ·æœ¬
  [æ•°æ®] ä¸´åºŠæ•°æ®: 1093 æ ·æœ¬, OSåˆ—: survival_months
         æœ‰æ•ˆ OS å€¼: 880 / 1093
  [åˆå¹¶] åŸºå› æ•°æ® 850 æ ·æœ¬ + ä¸´åºŠæ•°æ® 1093 æ ·æœ¬
         -> åˆå¹¶å 944 æ ·æœ¬ (OS + 100 åŸºå› )
    [Depth 0] å‘é‡åŒ–è®¡ç®—çš®å°”é€Šç›¸å…³æ€§çŸ©é˜µ...
    [Depth 0] å‘é‡åŒ–è®¡ç®—å®Œæˆï¼Œå¤„ç† 5050 å¯¹å˜é‡
    [Depth 1] æ­£åœ¨å¤„ç† 2702 æ¡è¾¹...
    [Stage2] PCç®—æ³•éª¨æ¶è¾¹æ•°: 1365
    [Stage2] PCç®—æ³•ç­›é€‰å®Œæˆ: ä» 100 -> 99 ä¸ªåŸºå› 
  [ä¿å­˜] features/mrmr_stage2_brca/fold_0_genes.csv
         åŸºå› æ•°: 99, æ ·æœ¬æ•°: 944

âœ… Fold 0 å®Œæˆ!
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### Step 1: mRMR ç‰¹å¾é€‰æ‹©

```bash
python run_mrmr.py \
  --study brca \
  --fold all \
  --split_dir ../../../splits/nested_cv \
  --data_root_dir ../../../datasets_csv/raw_rna_data/combine \
  --clinical_dir ../../../datasets_csv/clinical_data
```

è¾“å‡º: `features/mrmr_brca/fold_{0-4}_genes.csv` (æ¯ä¸ª fold 200ä¸ªåŸºå› )

### Step 2: Stage 2 ç²¾ç‚¼

```bash
python run_stage2_refinement.py \
  --study brca \
  --fold all \
  --clinical_dir ../../../datasets_csv/clinical_data
```

è¾“å‡º: `features/mrmr_stage2_brca/fold_{0-4}_genes.csv` (ç²¾ç‚¼åçš„åŸºå› )

### Step 3: åŸºå› ç­¾åæ¯”å¯¹

```bash
cd ../../../
bash scripts/quick_mrmr_compare.sh brca
```

## âš™ï¸ ç®—æ³•å‚æ•°

å¯ä»¥ä¿®æ”¹è„šæœ¬ä¸­çš„ PC ç®—æ³•å‚æ•°ï¼ˆä½äº `cs_step_2` å‡½æ•°è°ƒç”¨å¤„ï¼‰ï¼š

```python
# ç¬¬ 163 è¡Œ
G = skeleton(data, alpha=0.10, max_l=2)
```

- **alpha**: æ˜¾è‘—æ€§æ°´å¹³ï¼ˆé»˜è®¤ 0.10ï¼‰
  - è¶Šå°è¶Šä¸¥æ ¼ï¼Œä¿ç•™çš„è¾¹è¶Šå°‘
  - æ¨èèŒƒå›´: 0.05 - 0.15

- **max_l**: æ¡ä»¶é›†æœ€å¤§å¤§å°ï¼ˆé»˜è®¤ 2ï¼‰
  - è¶Šå¤§è¶Šç²¾ç¡®ï¼Œä½†è®¡ç®—æ—¶é—´æŒ‡æ•°å¢é•¿
  - æ¨èèŒƒå›´: 1 - 3

- **cutoff**: Markov Blanket è·ç¦»ï¼ˆé»˜è®¤ 2ï¼‰
  ```python
  # ç¬¬ 170 è¡Œ
  neighbors = list(nx.single_source_shortest_path_length(G_nx, OS_idx, cutoff=2).keys())
  ```
  - è·ç¦»1: åªä¿ç•™ä¸ OS ç›´æ¥ç›¸å…³çš„åŸºå› 
  - è·ç¦»2: ä¿ç•™ç›´æ¥å’Œé—´æ¥ï¼ˆé€šè¿‡1ä¸ªä¸­ä»‹ï¼‰ç›¸å…³çš„åŸºå› 

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡ŒåŒ–**: ä½¿ç”¨ `joblib.Parallel` è¿›è¡Œæ¡ä»¶ç‹¬ç«‹æ€§æµ‹è¯•ï¼ˆ16æ ¸ï¼‰
- **å‘é‡åŒ–**: Depth 0 ä½¿ç”¨ `pandas.corr()` æ‰¹é‡è®¡ç®—
- **å¢é‡å¤„ç†**: æ”¯æŒå• fold å¤„ç†ï¼Œé¿å…é‡å¤è®¡ç®—

## ğŸ› å¸¸è§é—®é¢˜

### Q1: æç¤º"æ‰¾ä¸åˆ° mRMR è¾“å…¥ç›®å½•"
**A**: è¯·å…ˆè¿è¡Œ `run_mrmr.py` ç”Ÿæˆ mRMR ç‰¹å¾ï¼š
```bash
python run_mrmr.py --study brca --fold all --split_dir ... --data_root_dir ...
```

### Q2: æ‰¾ä¸åˆ° OS åˆ—
**A**: ä¸´åºŠæ•°æ®å¿…é¡»åŒ…å«ä»¥ä¸‹åˆ—ä¹‹ä¸€ï¼š
- `OS` 
- `survival_months`
- `os_months`
- `OS_MONTHS`

### Q3: ç²¾ç‚¼ååŸºå› æ•°é‡å˜åŒ–ä¸å¤§
**A**: è¿™æ˜¯æ­£å¸¸çš„ã€‚Stage 2 çš„ä¸»è¦ä½œç”¨æ˜¯ï¼š
- ç§»é™¤ä¸ OS **ä¸ç›¸å…³**çš„åŸºå› 
- å¦‚æœ mRMR å·²ç»é€‰å‡ºäº†é«˜ç›¸å…³åŸºå› ï¼ŒStage 2 å¯èƒ½åªç§»é™¤å°‘é‡åŸºå› 
- å…³é”®åœ¨äºæé«˜ç‰¹å¾çš„**å› æœè§£é‡Šæ€§**ï¼Œè€Œéæ•°é‡

### Q4: è¿è¡Œæ—¶é—´è¾ƒé•¿
**A**: PC ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º O(n^2 * m)ï¼Œå…¶ä¸­ï¼š
- n: ç‰¹å¾æ•°é‡ï¼ˆ100-200ï¼‰
- m: æ ·æœ¬æ•°é‡ï¼ˆ500-1000ï¼‰

å…¸å‹è¿è¡Œæ—¶é—´ï¼š
- å•ä¸ª fold: 30-60ç§’
- æ‰€æœ‰ 5 folds: 3-5åˆ†é’Ÿ

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®è½¬ç½®è¯´æ˜

ç”±äº mRMR è¾“å‡ºæ ¼å¼æ˜¯ **è¡Œ=åŸºå› , åˆ—=æ ·æœ¬**ï¼Œè€Œ PC ç®—æ³•éœ€è¦ **è¡Œ=æ ·æœ¬, åˆ—=ç‰¹å¾**ï¼Œå› æ­¤éœ€è¦ï¼š

1. **è¾“å…¥æ—¶è½¬ç½®**: `df_genes.T`ï¼ˆå˜ä¸º æ ·æœ¬ x åŸºå› ï¼‰
2. **æ·»åŠ  OS åˆ—**: ä½œä¸ºç›®æ ‡å˜é‡
3. **è¿è¡Œ PC ç®—æ³•**
4. **è¾“å‡ºæ—¶è½¬ç½®**: `df_output.T`ï¼ˆæ¢å¤ä¸º åŸºå›  x æ ·æœ¬ï¼‰

### æ ·æœ¬ ID å¯¹é½

- æ‰€æœ‰æ ·æœ¬ ID ç»Ÿä¸€æˆªæ–­ä¸º **å‰12ä½** (TCGA-XX-XXXX)
- ä½¿ç”¨ `inner merge` ç¡®ä¿åŸºå› æ•°æ®å’Œä¸´åºŠæ•°æ®æ ·æœ¬ä¸€è‡´

## ğŸ“š å‚è€ƒæ–‡çŒ®

- Spirtes, P., Glymour, C., & Scheines, R. (2000). *Causation, Prediction, and Search*. MIT Press.
- PC Algorithm: https://en.wikipedia.org/wiki/PC_algorithm
- Markov Blanket: https://en.wikipedia.org/wiki/Markov_blanket
