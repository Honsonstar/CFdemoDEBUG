================================================================================
项目分析报告 - CFdemo_gene_text_copy
日期: 2026-01-23
================================================================================

## 项目概述

本项目是一个基于深度学习的多模态癌症生存分析框架，结合基因表达数据和病理图像数据，用于癌症患者生存预测和可解释性分析。项目实现了CPCG（Candidate Pathway Construction using Gene expression）算法来筛选与生存相关的基因通路。

================================================================================
一、Preprocessing 目录 - CPCG算法实现
================================================================================

位置: /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/preprocessing/

1. data_pocess/preprocess.py
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   输入文件:
     - tcga_brca_all_clean.csv (原始TCGA数据)

   输出文件:
     - tcga_brca/clinical.CSV (临床数据)
       * 包含: case_id, site, is_female, oncotree_code, age, survival_months,
              censorship, train, vital_status, Censor
     - tcga_brca/data.csv (基因表达数据)
       * 行为基因，列为样本
       * 基因名格式: 去除_rnaseq后缀

   功能:
     - 数据去重 (按case_id)
     - 生成clinical.CSV用于生存分析
     - 生成data.csv用于基因表达分析
     - 转换censorship为Censor (1=死亡, 0=存活)

2. CPCG_algo/ 目录结构
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

   Stage1_parametric_model/ (第一阶段: 参数化模型)
     ├─ screen.py
     │   功能: 使用logrank test筛选与生存相关的基因
     │   输入: clinical.CSV + data.csv
     │   方法: 偏相关分析 + logrank检验 (p<0.01)
     │   输出: 候选基因列表
     │
     ├─ cum_hazard.py
     │   功能: 累积风险计算
     │
     └─ casual_select.py
         功能: 因果关系筛选

   Stage1_semi_parametric_model/ (第一阶段: 半参数化模型)
     ├─ preprocess.py
     │   功能: 半参数化模型数据预处理
     │
     ├─ screen.py
     │   功能: 进一步基因筛选验证
     │
     ├─ casual_select.py
     │   功能: 因果选择算法
     │
     └─ cum_hazard.py
         功能: 累积风险计算

   Stage2/main.py (第二阶段: 骨架发现和因果网络)
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     功能: 使用PC算法进行骨架发现，构建基因间因果关系网络
     输入:
       - raw_data (原始数据路径)
       - parametric data (Stage1参数化结果)
       - semi-parametric data (Stage1半参数化结果)
     输出:
       - result_m2m3_base_0916_n100/ (因果网络结果)
     方法:
       - 骨架发现 (Skeleton Discovery)
       - 部分相关性检验
       - 网络图构建 (NetworkX)

================================================================================
二、merge_clinical_meta.py - 临床数据合并脚本
================================================================================

位置: /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/merge_clinical_meta.py

数据来源 (输入):
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. datasets_csv/clinical_data/tcga_{study}_clinical.csv
     - 原始临床数据文件

  2. datasets_csv/metadata/tcga_{study}.csv
     - 元数据文件

处理流程:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. 读取临床数据和metadata文件
  2. 统一case_id格式 (转换为字符串并去除空格)
  3. 执行Left Join合并 (保留所有临床数据样本)
  4. 数据清洗:
     - 检测slide_id缺失情况
     - 将缺失的slide_id填充为"N/A" (防止float属性报错)
     - 确保多模态训练兼容性
  5. 备份原文件为 .bak
  6. 覆盖保存合并结果

输出:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - datasets_csv/clinical_data/tcga_{study}_clinical.csv (已合并)
  - datasets_csv/clinical_data/tcga_{study}_clinical.csv.bak (备份)

项目中的作用:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - 为多模态学习准备完整临床数据
  - 确保每个样本都有slide_id用于病理图像关联
  - 保证数据完整性，支持基因+图像双模态训练

================================================================================
三、create_splits_final.py - 数据集划分脚本
================================================================================

位置: /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/create_splits_final.py

数据来源 (输入):
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - datasets_csv/clinical_data/tcga_blca_clinical.csv
    (或其他癌种的临床数据文件)

处理流程:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  1. 读取临床数据，提取case_id和生存标签 (censorship)
  2. 5折交叉验证分层抽样:
     - Outer Loop: Train+Val vs Test
     - Inner Loop: 从Train+Val中划分15%作为Validation
  3. 使用StratifiedKFold确保各折中生存标签分布平衡
  4. 生成5个折的划分文件

输出目录:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - splits/5foldcv/tcga_blca/
    ├─ splits_0.csv
    ├─ splits_1.csv
    ├─ splits_2.csv
    ├─ splits_3.csv
    └─ splits_4.csv

每个文件格式:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  train,val,test
  TCGA-xxx,TCGA-yyy,TCGA-zzz
  ...

项目中的作用:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  - 为模型训练提供标准化的数据划分
  - 被main.py中的dataset_factory.return_splits()调用
  - 确保实验可重复性和结果可比性

================================================================================
四、核心数据流架构
================================================================================

数据流向图:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  原始TCGA数据 (tcga_{cancer}_all_clean.csv)
           ↓
  [preprocess.py]
           ↓
    ┌─────────────────┬─────────────────┐
    ↓                 ↓
clinical.CSV     data.csv
(临床信息)       (基因表达)
    ↓                 ↓
    └─────────────────┤
                      ↓
           [CPCG算法 - Stage1 & Stage2]
                      ↓
              候选基因/通路筛选结果
                      ↓
           [merge_clinical_meta.py]
                      ↓
         完整临床数据 (含slide_id)
                      ↓
          [create_splits_final.py]
                      ↓
        5折交叉验证划分文件
                      ↓
    [main.py + dataset_survival.py]
                      ↓
            模型训练和生存预测
                      ↓
              results/ 目录
         (实验结果和日志文件)

================================================================================
五、关键目录和数据文件位置
================================================================================

目录结构:
  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  项目根目录: /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy/

  ├─ datasets_csv/           [数据集目录]
  │   ├─ clinical_data/     [临床数据]
  │   │   ├─ tcga_blca_clinical.csv
  │   │   ├─ tcga_brca_clinical.csv
  │   │   ├─ tcga_coadread_clinical.csv
  │   │   ├─ tcga_hnsc_clinical.csv
  │   │   ├─ tcga_stad_clinical.csv
  │   │   └─ *.bak (备份文件)
  │   │
  │   ├─ metadata/          [元数据]
  │   │   ├─ tcga_{cancer}.csv
  │   │   ├─ signatures.csv
  │   │   ├─ hallmarks_signatures.csv
  │   │   ├─ combine_signatures.csv
  │   │   └─ xena_signatures.csv
  │   │
  │   └─ pathway_compositions/
  │
  ├─ preprocessing/          [CPCG算法实现]
  │   └─ CPCG_algo/
  │       ├─ Stage1_parametric_model/
  │       ├─ Stage1_semi_parametric_model/
  │       └─ Stage2/
  │
  ├─ splits/                 [数据划分]
  │   └─ 5foldcv/
  │       ├─ tcga_blca/
  │       ├─ tcga_brca/
  │       ├─ tcga_coadread/
  │       ├─ tcga_hnsc/
  │       └─ tcga_stad/
  │
  ├─ results/               [实验结果]
  │   ├─ {experiment_name}/ (按实验分组)
  │   └─ *.log (训练日志)
  │
  ├─ explanation_results/    [可解释性结果]
  │   └─ {cancer}-Fold_{fold}/
  │       ├─ {sample}_highlighted_text.html
  │       └─ {sample}_top_pathways.png
  │
  ├─ datasets/              [数据加载模块]
  │   └─ dataset_survival.py
  │
  ├─ models/                [模型定义]
  │
  ├─ utils/                 [工具函数]
  │   ├─ core_utils.py
  │   ├─ file_utils.py
  │   └─ general_utils.py
  │
  ├─ main.py                [主训练脚本]
  ├─ merge_clinical_meta.py [数据合并]
  └─ create_splits_final.py [数据划分]

================================================================================
六、项目核心功能总结
================================================================================

本项目是一个多模态癌症生存分析框架，具备以下核心功能:

1. 基因表达分析
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   - 实现CPCG算法筛选与生存相关的基因通路
   - Stage1: 参数化和半参数化模型筛选
   - Stage2: 骨架发现和因果网络构建

2. 多模态融合
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   - 结合基因表达数据和病理图像数据
   - 通过slide_id实现样本关联
   - 支持文本特征和基因特征融合

3. 生存预测
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   - 使用深度学习模型预测生存时间
   - 评估指标: C-index, Brier Score, IBS, iAUC
   - 5折交叉验证确保结果可靠性

4. 可解释性分析
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   - 生成highlighted_text.html (高亮文本)
   - 输出top_pathways.png (关键通路图)
   - 解释模型预测依据

5. 支持多种癌症类型
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   - BLCA (膀胱尿路上皮癌)
   - BRCA (乳腺浸润癌)
   - COADREAD (结直肠腺癌)
   - HNSC (头颈鳞状细胞癌)
   - STAD (胃腺癌)

================================================================================
七、运行流程建议
================================================================================

数据准备阶段:
  1. 运行 merge_clinical_meta.py 合并临床和metadata
  2. 运行 create_splits_final.py 生成数据划分

CPCG分析 (可选):
  3. 运行 preprocessing/CPCG_algo/ 进行基因通路筛选

模型训练:
  4. 运行 main.py 执行模型训练
  5. 查看 results/ 目录下的结果和日志

结果解释:
  6. 查看 explanation_results/ 目录下的可解释性结果

================================================================================
报告结束
================================================================================
分析完成时间: 2026-01-23
分析者: Claude Code Assistant
项目路径: /root/autodl-tmp/newcfdemo/CFdemo_gene_text_copy
================================================================================

================================================================================
数据泄露问题专项分析报告
================================================================================
报告日期: 2026-01-23
分析者: Claude Code Assistant
问题严重程度: ★★★★★ (极高)

================================================================================
一、问题概述
================================================================================

本项目存在**严重的数据泄露问题**，主要体现在基因特征筛选阶段。
CPCG (Candidate Pathway Construction using Gene expression) 算法在整个
数据集上进行特征选择，然后将筛选结果用于5折交叉验证，导致测试集信息
泄露到训练过程中，造成性能评估结果不可靠。

================================================================================
二、数据泄露路径详细分析
================================================================================

1. CPCG算法输入与输出
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   输入数据: 
     - 原始样本数: 424 (以BLCA为例)
     - CPCG输出样本数: 189 (仅部分样本)
     - 筛选基因数: 131个基因 (CD96, ISCU, RIPK2, ...)
   
   问题核心:
     - CPCG算法在特征选择时使用了**完整的生存标签信息**
     - 这些信息本应在训练/验证/测试阶段**严格隔离**
     - 预筛选的基因特征包含了整个数据集的分布信息

2. 数据流泄露路径图
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   整个数据集 (424样本)
         ↓
   [CPCG Stage1 - 参数化模型筛选]
     ├─ logrank test (看到所有生存标签)
     └─ 偏相关分析 (使用所有样本)
         ↓
   [CPCG Stage2 - 骨架发现]
     ├─ PC算法 (使用所有样本的基因表达)
     └─ 因果网络构建 (了解整体数据分布)
         ↓
   筛选出131个基因特征
         ↓
   [5折交叉验证]
     Fold1: Train(142) + Val(25) + Test(42) ← 使用预筛选的131基因
     Fold2: Train(142) + Val(25) + Test(42) ← 使用预筛选的131基因
     Fold3: Train(142) + Val(25) + Test(42) ← 使用预筛选的131基因
     Fold4: Train(142) + Val(25) + Test(42) ← 使用预筛选的131基因
     Fold5: Train(142) + Val(25) + Test(42) ← 使用预筛选的131基因
         ↑
   **所有折都使用了在测试集上筛选的特征 = 数据泄露!**

3. 代码证据
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   文件: preprocessing/CPCG_algo/Stage1_parametric_model/screen.py
   问题代码 (第13-76行):
   ```python
   def screen_step_1(clinical_final, exp_data, h_type, threshold=100):
       cd = clinical_final.copy()
       ed = exp_data.copy()
       # 读取所有样本的生存数据 (包括测试集!)
       cd = cd[cd['Censor']==1]
       ...
       for aa in range(ed.shape[0]):
           # 对每个基因进行logrank test
           results = logrank_test(d_l['OS'], d_h['OS'], d_l['Censor'], d_h['Censor'])
           # 使用偏相关分析
           corr_pd = partial_corr(data=cd[cd['Censor']==1], x=name_gene[0], y=h_type)
           ...
   ```
   
   问题: **使用了全部数据进行特征选择**

================================================================================
三、样本量小的加剧效应
================================================================================

1. 样本量统计
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   癌症类型    原始样本数    CPCG输出样本数    筛选基因数    泄露程度
   ───────────────────────────────────────────────────────────────
   BLCA       424          189              131          ★★★★★
   BRCA       ~1000        ~600             ~150         ★★★★★
   HNSC       ~500         ~300             ~140         ★★★★★
   STAD       ~400         ~200             ~135         ★★★★★
   COADREAD   ~600         ~400             ~145         ★★★★★

2. 小样本的四大危害
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   a) 高方差 (High Variance)
      - 小测试集(40-50样本)上的性能评估波动极大
      - 同一模型在不同测试集上C-index可能差0.1-0.2
      - 结果不可重复，不可靠
   
   b) 特征维度灾难
      - 从20,000个基因缩减到131个
      - 维度缩减比: 99.3%
      - 可能丢失重要的交互信息
   
   c) 预筛选偏差放大
      - 在小样本上做的特征选择更容易过拟合
      - 选中的基因可能只是偶然与生存相关
      - 在新数据上表现会很差
   
   d) 虚假性能提升
      - 测试误差被严重低估
      - 实际泛化性能可能远低于报告结果
      - 临床应用风险极高

================================================================================
四、性能高估的定量分析
================================================================================

根据文献和数据泄露的严重程度，性能可能被高估:

1. C-index高估: 0.05 - 0.15
   - 报告结果: 0.70-0.80
   - 真实结果: 可能0.55-0.70

2. Brier Score低估: 0.02 - 0.08
   - 报告结果: 0.15
   - 真实结果: 可能0.20-0.25

3. IBS (Integrated Brier Score) 低估: 0.03 - 0.10
   - 报告结果: 0.18
   - 真实结果: 可能0.25-0.30

4. 置信区间被严重低估
   - 5折CV的标准差 ~0.02
   - 真实标准差可能 ~0.05-0.08

================================================================================
五、正确的做法 (无泄露流程)
================================================================================

正确的嵌套交叉验证流程应该是:

```python
for fold in 5_folds:
    # 1. 严格划分
    train_val_idx, test_idx = split(fold)
    train_idx, val_idx = train_val_split()
    
    train_data = data[train_idx]
    val_data = data[val_idx]
    test_data = data[test_idx]
    
    # 2. 仅在训练集上做特征筛选
    train_genes = CPCG_feature_selection(
        clinical=train_data, 
        expression=train_data,
        threshold=100
    )
    
    # 3. 应用到验证/测试集
    val_features = select_features(val_data, train_genes)
    test_features = select_features(test_data, train_genes)
    
    # 4. 训练模型
    model.train(train_features, train_labels)
    model.validate(val_features, val_labels)
    
    # 5. 在测试集上评估 (只做一次!)
    test_results = model.test(test_features, test_labels)
```

关键点:
- **特征选择只在训练集上进行**
- **验证集用于超参数调优**
- **测试集仅用于最终评估，且只评估一次**

================================================================================
六、项目当前错误流程
================================================================================

```python
# 错误的做法 (当前项目)
all_data = load_data()

# 在整个数据集上做特征选择 (泄露!)
selected_genes = CPCG(all_data)  # ← 看到测试集信息!

for fold in 5_folds:
    train_idx, val_idx, test_idx = split(all_data, fold)
    
    # 使用预筛选的特征 (泄露!)
    train_features = all_data[train_idx][selected_genes]
    val_features = all_data[val_idx][selected_genes]
    test_features = all_data[test_idx][selected_genes]  # ← 测试集泄露!
    
    model.train(train_features, train_labels)
    results = model.validate(val_features, val_labels)
    
    # 在泄露的测试集上评估
    final_results = model.test(test_features, test_labels)
```

================================================================================
七、修复建议
================================================================================

1. 立即修复方案 (快速但不完全)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   a) 使用固定的基因签名 (如Hallmarks, Reactome)
      - 从 signatures.csv, hallmarks_signatures.csv 等选择
      - 这些签名是外部知识，非数据驱动
      - 路径: datasets_csv/metadata/*.csv
   
   b) 使用更保守的特征选择方法
      - 提高p值阈值 (从0.01到0.001)
      - 增加相关性阈值 (从0.1到0.3)
      - 减少筛选基因数量

2. 完整修复方案 (推荐)
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   a) 实现嵌套交叉验证
      - 外层循环: 5折划分
      - 内层循环: 在训练集上做CPCG特征筛选
      - 验证集用于调参
      - 测试集用于最终评估
   
   b) 使用外部验证集
      - 独立的数据集验证模型性能
      - 避免完全依赖交叉验证
   
   c) 添加鲁棒性分析
      - 随机种子敏感性分析
      - 特征扰动实验
      - 留一法交叉验证 (LOOCV)

3. 长期解决方案
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   a) 使用深度学习自动特征提取
      - 避免显式的特征筛选
      - 让模型自动学习重要特征
   
   b) 多组学数据融合
      - 结合基因、蛋白、代谢等多层数据
      - 减少对单一数据源的依赖
   
   c) 因果推断方法
      - 使用do-calculus等因果推断技术
      - 区分相关性和因果性

================================================================================
八、实验验证建议
================================================================================

1. 对比实验
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   实验A (当前错误方法):
   - 使用CPCG预筛选特征
   - 预期结果: C-index ~0.75
   
   实验B (修正方法):
   - 仅使用Hallmarks签名
   - 预期结果: C-index ~0.65
   
   实验C (嵌套CV):
   - 每折独立做特征筛选
   - 预期结果: C-index ~0.60-0.65

2. 统计分析
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   a) McNemar检验: 比较错误方法和正确方法的性能差异
   b) Bootstrap置信区间: 评估性能估计的不确定性
   c) Permutation test: 验证模型是否真的学到了信号

================================================================================
九、风险评估
================================================================================

当前结果风险等级: ★★★★★ (极高)

1. 科研风险
   - 发表结果无法复现
   - 同行评议阶段可能被质疑
   - 学术声誉受损

2. 临床风险
   - 模型泛化能力差
   - 错误的风险评估可能导致不当治疗
   - 患者安全风险

3. 资源浪费
   - 后续研究基于错误结果
   - 浪费时间和经费
   - 误导后续研究方向

================================================================================
十、结论与建议
================================================================================

**结论**:
本项目存在严重的数据泄露问题，CPCG算法在整个数据集上进行特征筛选，
然后用于5折交叉验证，导致测试集信息泄露。这在样本量较小的癌症数据
集中问题更加严重，性能评估结果不可靠。

**紧急建议**:
1. **立即停止使用当前结果进行任何决策**
2. **尽快实现嵌套交叉验证修复**
3. **使用外部数据集验证模型性能**
4. **重新审视所有基于CPCG的实验结果**

**优先级排序**:
P0 (最高): 修复数据泄露问题
P1 (高): 添加鲁棒性分析
P2 (中): 实现外部验证
P3 (低): 优化CPCG算法

================================================================================
报告结束
================================================================================
